-- ===== é¦™è•‰ç—…æ¯’ Â· å…¨èº«ç²˜è´´ç‰ˆ =====
Players = cloneref(game:GetService("Players"))
RunService = cloneref(game:GetService("RunService"))
ReplicatedStorage = cloneref(game:GetService("ReplicatedStorage"))
LocalPlayer = Players.LocalPlayer
Character = LocalPlayer.Character
Humanoid = Character and Character:FindFirstChildOfClass("Humanoid")
HumanoidRootPart = Character and Character:FindFirstChild("HumanoidRootPart")

LocalPlayer.CharacterAdded:Connect(function(char)
    Character = char
    HumanoidRootPart = char:WaitForChild("HumanoidRootPart")
    Humanoid = char:WaitForChild("Humanoid")
end)

-- ===== UI - æç®€é£æ ¼ =====
local WindUI = loadstring(game:HttpGet("https://raw.githubusercontent.com/454244513/WindUIFix/refs/heads/main/main.lua"))()
local Window = WindUI:CreateWindow({
    Title = "ğŸŒ é¦™è•‰ç—…æ¯’",
    OpenButton = {
        Title = "ğŸŒ",
        CornerRadius = UDim.new(0, 20),
        StrokeThickness = 2,
        Color = ColorSequence.new(Color3.fromHex("ffd700")),
        OnlyMobile = true,
        Scale = 0.5,
    },
})

local Tab = Window:Tab({ Title = "Main" })
Tab:Select()

local BananaMode = false
local StickSpeed = 0.3

Tab:Toggle({
    Title = "ğŸŒ å…¨èº«ç²˜è´´",
    Callback = function(v) BananaMode = v end,
})

Tab:Slider({
    Title = "âš¡ ç²˜è´´é€Ÿåº¦",
    Min = 0.1,
    Max = 1,
    Default = 0.3,
    Increase = 0.05,
    Callback = function(v) StickSpeed = v end,
})

-- ===== åŠ è½½è¿œç¨‹ =====
load = require(ReplicatedStorage.devv).load
Signal = load("Signal")
FireServer = Signal.FireServer
InvokeServer = Signal.InvokeServer
GUID = load("GUID")
v3item = load("v3item")
inventory = v3item.inventory

-- ===== è·å–é¦™è•‰ =====
function getBanana()
    for guid, data in pairs(inventory.items) do
        if data.name == "Banana Peel" then
            return data
        end
    end
end

-- ===== è‡ªåŠ¨è´­ä¹° =====
function buyBanana()
    task.spawn(InvokeServer, "attemptPurchase", "Banana Peel")
end

-- ===== ç²˜è´´åˆ°æ•Œäººå…¨èº« =====
function stickBananaToEnemy(enemy)
    if not enemy or not enemy.Character then return end
    
    local banana = getBanana()
    if not banana then
        buyBanana()
        return
    end
    
    FireServer("equip", banana.guid)
    
    -- è·å–æ•Œäººæ‰€æœ‰å¯ç²˜è´´éƒ¨ä½
    local parts = {}
    local char = enemy.Character
    
    -- ä¸»è¦éƒ¨ä½
    local root = char:FindFirstChild("HumanoidRootPart")
    local head = char:FindFirstChild("Head")
    local torso = char:FindFirstChild("UpperTorso") or char:FindFirstChild("Torso")
    local lower = char:FindFirstChild("LowerTorso")
    local leftArm = char:FindFirstChild("LeftArm") or char:FindFirstChild("LeftUpperArm")
    local rightArm = char:FindFirstChild("RightArm") or char:FindFirstChild("RightUpperArm")
    local leftLeg = char:FindFirstChild("LeftLeg") or char:FindFirstChild("LeftLowerLeg")
    local rightLeg = char:FindFirstChild("RightLeg") or char:FindFirstChild("RightLowerLeg")
    
    if root then table.insert(parts, root) end
    if head then table.insert(parts, head) end
    if torso then table.insert(parts, torso) end
    if lower then table.insert(parts, lower) end
    if leftArm then table.insert(parts, leftArm) end
    if rightArm then table.insert(parts, rightArm) end
    if leftLeg then table.insert(parts, leftLeg) end
    if rightLeg then table.insert(parts, rightLeg) end
    
    -- æ¯ä¸ªéƒ¨ä½è´´é¦™è•‰
    for _, part in ipairs(parts) do
        local guid = GUID()
        pcall(function()
            InvokeServer("hitSticky", guid, part,
                part.CFrame:ToObjectSpace(CFrame.new(part.Position)),
                CFrame.new(part.Position)
            )
        end)
        task.wait(0.05) -- é˜²æ­¢è¿‡å¿«
    end
    
    -- æ¶ˆè€—é¦™è•‰
    task.spawn(function()
        task.wait(0.2)
        pcall(function() FireServer("removeItem", banana.guid) end)
    end)
end

-- ===== ç›®æ ‡ç®¡ç† =====
local targets = {}
local lastStick = {}

-- ===== ä¸»å¾ªç¯ - ç¾¤æ”»å…¨èº«ç²˜è´´ =====
RunService.Heartbeat:Connect(function()
    if not BananaMode or not HumanoidRootPart then return end
    
    -- æ‰«ææ•Œäºº
    targets = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local hum = player.Character:FindFirstChildOfClass("Humanoid")
            local head = player.Character:FindFirstChild("Head")
            if hum and hum.Health > 0 and head then
                local dist = (HumanoidRootPart.Position - head.Position).Magnitude
                if dist < 190 then
                    table.insert(targets, player)
                end
            end
        end
    end
    
    -- æ”»å‡»æ‰€æœ‰æ•Œäºº
    for _, enemy in ipairs(targets) do
        if not lastStick[enemy] then
            lastStick[enemy] = 0
        end
        
        if tick() - lastStick[enemy] >= StickSpeed then
            stickBananaToEnemy(enemy)
            lastStick[enemy] = tick()
        end
    end
end)

-- ===== æ¸…ç†æ­»äº¡ç›®æ ‡ =====
task.spawn(function()
    while task.wait(2) do
        for enemy in pairs(lastStick) do
            if not enemy or not enemy.Character or not enemy.Character:FindFirstChildOfClass("Humanoid") or
               enemy.Character.Humanoid.Health <= 0 then
                lastStick[enemy] = nil
            end
        end
    end
end)

-- ===== è‡ªåŠ¨è¡¥è´§ =====
task.spawn(function()
    while task.wait(1.5) do
        if BananaMode and not getBanana() then
            pcall(function() InvokeServer("attemptPurchase", "Banana Peel") end)
        end
    end
end)